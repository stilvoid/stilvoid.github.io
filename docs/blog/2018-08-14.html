<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>engledow.me: Heroes: Building some old code</title>
        <link rel="stylesheet" href="/style.css">
    </head>

    <body>
        <nav><ul><li><a href="/index.html">About</a></li>

<li><a href="/blog/index.html" class="selected">Blog</a></li>

<li><a href="/projects/index.html">Projects</a></li>
</ul>

<ul><li><a href="/blog/2024-08-28.html">TBC</a><br><span class="date">(2024-08-28)</span></li>

<li><a href="/blog/2024-07-23.html">Back to the Primitive</a><br><span class="date">(2024-07-23)</span></li>

<li><a href="/blog/2019-11-13.html">Maur - A minimal AUR helper</a><br><span class="date">(2019-11-13)</span></li>

<li><a href="/blog/2019-02-12.html">Using Git with AWS CodeCommit Across Multiple AWS Accounts</a><br><span class="date">(2019-02-12)</span></li>

<li><a href="/blog/2018-11-08.html">git-get</a><br><span class="date">(2018-11-08)</span></li>

<li><a href="/blog/2018-08-14.html" class="selected">Heroes: Building some old code</a><br><span class="date">(2018-08-14)</span></li>

<li><a href="/blog/2018-06-03.html">Shue</a><br><span class="date">(2018-06-03)</span></li>

<li><a href="/blog/2017-07-10.html">An evening of linux on the desktop</a><br><span class="date">(2017-07-10)</span></li>

<li><a href="/blog/2017-06-15.html">The day of linux on the desktop</a><br><span class="date">(2017-06-15)</span></li>

<li><a href="/blog/2016-02-25.html">Digital Subscriber</a><br><span class="date">(2016-02-25)</span></li>

<li><a href="/blog/2015-12-14.html">Ford</a><br><span class="date">(2015-12-14)</span></li>

<li><a href="/blog/2015-11-30.html">Sorted</a><br><span class="date">(2015-11-30)</span></li>

<li><a href="/blog/2015-09-17.html">Twofer</a><br><span class="date">(2015-09-17)</span></li>

<li><a href="/blog/2015-06-22.html">Pretty please</a><br><span class="date">(2015-06-22)</span></li>

<li><a href="/blog/2015-05-15.html">Andy and Teddy are waving goodbye</a><br><span class="date">(2015-05-15)</span></li>

<li><a href="/blog/2015-05-14.html">Building a componentised application</a><br><span class="date">(2015-05-14)</span></li>

<li><a href="/blog/2015-04-29.html">Why-fi?</a><br><span class="date">(2015-04-29)</span></li>

<li><a href="/blog/2015-03-12.html">Cleaning out my closet</a><br><span class="date">(2015-03-12)</span></li>

<li><a href="/blog/2015-01-02.html">Keychain and GnuPG >= 2.1</a><br><span class="date">(2015-01-02)</span></li>

<li><a href="/blog/2014-12-09.html">Testing a Django app with Docker</a><br><span class="date">(2014-12-09)</span></li>

<li><a href="/blog/2014-12-01.html">Just call me Anneka</a><br><span class="date">(2014-12-01)</span></li>

<li><a href="/blog/2014-06-17.html">tmux</a><br><span class="date">(2014-06-17)</span></li>

<li><a href="/blog/2014-04-15.html">Netcat</a><br><span class="date">(2014-04-15)</span></li>

<li><a href="/blog/2014-01-31.html">btw</a><br><span class="date">(2014-01-31)</span></li>

<li><a href="/blog/2013-05-10.html">Things we learned at the LUG meet</a><br><span class="date">(2013-05-10)</span></li>

<li><a href="/blog/2013-02-11.html">Git aux</a><br><span class="date">(2013-02-11)</span></li>

<li><a href="/blog/2012-08-30.html">Lost at C</a><br><span class="date">(2012-08-30)</span></li>

<li><a href="/blog/2012-07-07.html">Ire</a><br><span class="date">(2012-07-07)</span></li>

<li><a href="/blog/2011-10-27.html">Break In!</a><br><span class="date">(2011-10-27)</span></li>

<li><a href="/blog/2011-10-22.html">xmodmap Hints and Tips</a><br><span class="date">(2011-10-22)</span></li>
</ul>
</nav>

        <main>
            <h1>Heroes: Building some old code</h1>
<p>For the end result of this post, see <a href="https://aur.archlinux.org/packages/heroes/">my AUR package of
Heroes</a>.</p>
<hr />
<p>The other day, something reminded me of a game I used to really enjoy
playing back in my early days of getting to know Linux. That game was
<a href="http://heroes.sourceforge.net">Heroes</a>. It's a clone of
<a href="https://en.wikipedia.org/wiki/Snake_(video_game_genre)">Snake/Tron/Nibbles</a>
but with some fun additions, a nice graphical style, and some funky
visual effects.</p>
<p><img alt="Heroes
screenshot" src="https://static.offend.me.uk/media/images/2018-08-14-heroes-screenshot.png" /></p>
<p>So, of course, I immediately decided to install it.</p>
<pre><code>$ pacman -Ss heroes
</code></pre>
<p>No results. Nothing in the
<a href="https://wiki.archlinux.org/index.php/Arch_User_Repository">AUR</a> either.
There is only one other course of action: I'm going to create an AUR
package for it!</p>
<p>It looks like the last change to the game was 16 years ago so it could
be fun getting it to compile with a modern toolchain.</p>
<h2>Getting Heroes to compile in 2018</h2>
<p>I put together a basic
<a href="https://wiki.archlinux.org/index.php/PKGBUILD">PKGBUILD</a> that pulls
down the source and data files from the Heroes sourceforge page and then
runs:</p>
<pre><code>./configure
make
</code></pre>
<p>Here's the first of what I'm sure are many failure messages:</p>
<pre><code>hedlite.c:48:20: error: static declaration of ‘tile_set_img’ follows non-static declaration 
 static a_pcx_image tile_set_img;
                    ^~~~~~~~~~~~
In file included from hedlite.c:44:
const.h:52:20: note: previous declaration of ‘tile_set_img’ was here                        
 extern a_pcx_image tile_set_img, font_deck_img;                                            
                    ^~~~~~~~~~~~
</code></pre>
<p>Some forewarning: it's been quite some time since I wrote anything
serious in C and I was never an expert in it anyway. But I think I know
enough to fix this and so just commented out the static declaration as,
after poking around in the code a bit, it doesn't seem like it's
necessary anyway.</p>
<p>Now the compilation succeeds but I get the following error during
linking:</p>
<pre><code>/usr/bin/ld: camera.o: undefined reference to symbol 'sin@@GLIBC_2.2.5'
/usr/bin/ld: /usr/lib/libm.so.6: error adding symbols: DSO missing from command line
</code></pre>
<p>Turns out that for some reason, the developers forgot to include the
math\&lt;small&gt;(s)\&lt;/small&gt; library. I'm guessing that perhaps it used to
be linked by default in a previous version of GCC.</p>
<pre><code>LDFLAGS=-lm ./configure
make
</code></pre>
<p>Now it at least compiles correctly! Next up, compiling the data, music,
and sound effects packages.</p>
<p>Amazingly, those all worked correctly and I was able to play the game!</p>
<p>However, this game was written a while ago and originally targeted
MS-DOS so it has a window size of 320x200 which looks rather ridiculous
on my 1920x1080 desktop ;)</p>
<p><a href="https://static.offend.me.uk/media/images/2018-08-14-heroes.png"><img alt="Tiny Heroes window
screenshot" src="https://static.offend.me.uk/media/images/2018-08-14-heroes-small.png" /></a></p>
<p>So I set about trying to set the default screen mode so that the game
starts in full screen...</p>
<p>Fortunately, it looks like this is relatively easy. I just modified a
few variables and changed a command line flag from <code>-F | --full-screen</code>
to <code>-W | --windowed</code>.</p>
<p>Next up, rather than rely on <a href="https://www.libsdl.org/">SDL</a>'s built-in
scaling (it looks blurry and weird), I need to enable Heroes' quadruple
flag <code>-4</code> by default. In fact, I removed all the scaling options and
just left it to default to scaling 4-fold as that leaves the game with a
resolution of 1280x800 which seems a reasonable default these days. I'm
sure I'll receive bug reports if it's not ;)</p>
<p>The very last thing I've done is to enable the high quality mixer by
default and remove the command line option from the game. CPU is a
little more abundant now than it was in 2002 ;)</p>
<p><a href="https://aur.archlinux.org/cgit/aur.git/tree/heroes-0.21.patch?h=heroes">Here's my final patch
file</a>.</p>
<h2>Submitting the AUR package</h2>
<p>Things have changed since I last submitted a package to the AUR so
here's a brief writeup - if only to remind myself in future ;)</p>
<p>First step was to update the SSH key in my AUR account as it contained a
key from my old machine.</p>
<p>Next up, I added a remote to my repository:</p>
<pre><code>$ git remote add aur ssh://aur@aur.archlinux.org/heroes.git
$ git fetch aur  # This step causes AUR to create a record for the package
</code></pre>
<p>The next step is to generate AUR's <code>.SRCINFO</code> file and rebase it into
every commit (AUR requires this).</p>
<pre><code>$ git filter-branch --tree-filter "makepkg --printsrcinfo &gt; .SRCINFO"
</code></pre>
<p>And then push it to the AUR repository:</p>
<pre><code>$ git push -u aur master
</code></pre>
<h2>Testing it out</h2>
<p>I use <a href="https://aur.archlinux.org/packages/packer/">packer</a> to make using
AUR easier <a href="https://thethreevirtues.com/">I'm lazy</a>).</p>
<pre><code>$ packer -S heroes
</code></pre>
<p>SUCCESS!</p>
<p>All in all, this wasn't anywhere near as painful as I'd expected. Time
to play some Heroes :D</p>

            <footer>&copy; 2024, Steve Engledow</footer>
        </main>
    </body>
</html>
