<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>engledow.me: Lost at C</title>
        <link rel="stylesheet" href="/style.css">
        <link rel="me" href="https://retro.pizza/@stilvoid">
        <meta name="fediverse:creator" content="@stilvoid@retro.pizza">
    </head>

    <body>
        <nav><ul><li><a href="/index.html">About</a></li>

<li><a href="/blog/index.html" class="selected">Blog</a></li>

<li><a href="/projects/index.html">Projects</a></li>
</ul>

<ul><li><a href="/blog/2024-08-28.html">TBC</a><br><span class="date">(2024-08-28)</span></li>

<li><a href="/blog/2024-07-23.html">Back to the Primitive</a><br><span class="date">(2024-07-23)</span></li>

<li><a href="/blog/2019-11-13.html">Maur - A minimal AUR helper</a><br><span class="date">(2019-11-13)</span></li>

<li><a href="/blog/2019-02-12.html">Using Git with AWS CodeCommit Across Multiple AWS Accounts</a><br><span class="date">(2019-02-12)</span></li>

<li><a href="/blog/2018-11-08.html">git-get</a><br><span class="date">(2018-11-08)</span></li>

<li><a href="/blog/2018-08-14.html">Heroes: Building some old code</a><br><span class="date">(2018-08-14)</span></li>

<li><a href="/blog/2018-06-03.html">Shue</a><br><span class="date">(2018-06-03)</span></li>

<li><a href="/blog/2017-07-10.html">An evening of linux on the desktop</a><br><span class="date">(2017-07-10)</span></li>

<li><a href="/blog/2017-06-15.html">The day of linux on the desktop</a><br><span class="date">(2017-06-15)</span></li>

<li><a href="/blog/2016-02-25.html">Digital Subscriber</a><br><span class="date">(2016-02-25)</span></li>

<li><a href="/blog/2015-12-14.html">Ford</a><br><span class="date">(2015-12-14)</span></li>

<li><a href="/blog/2015-11-30.html">Sorted</a><br><span class="date">(2015-11-30)</span></li>

<li><a href="/blog/2015-09-17.html">Twofer</a><br><span class="date">(2015-09-17)</span></li>

<li><a href="/blog/2015-06-22.html">Pretty please</a><br><span class="date">(2015-06-22)</span></li>

<li><a href="/blog/2015-05-15.html">Andy and Teddy are waving goodbye</a><br><span class="date">(2015-05-15)</span></li>

<li><a href="/blog/2015-05-14.html">Building a componentised application</a><br><span class="date">(2015-05-14)</span></li>

<li><a href="/blog/2015-04-29.html">Why-fi?</a><br><span class="date">(2015-04-29)</span></li>

<li><a href="/blog/2015-03-12.html">Cleaning out my closet</a><br><span class="date">(2015-03-12)</span></li>

<li><a href="/blog/2015-01-02.html">Keychain and GnuPG >= 2.1</a><br><span class="date">(2015-01-02)</span></li>

<li><a href="/blog/2014-12-09.html">Testing a Django app with Docker</a><br><span class="date">(2014-12-09)</span></li>

<li><a href="/blog/2014-12-01.html">Just call me Anneka</a><br><span class="date">(2014-12-01)</span></li>

<li><a href="/blog/2014-06-17.html">tmux</a><br><span class="date">(2014-06-17)</span></li>

<li><a href="/blog/2014-04-15.html">Netcat</a><br><span class="date">(2014-04-15)</span></li>

<li><a href="/blog/2014-01-31.html">btw</a><br><span class="date">(2014-01-31)</span></li>

<li><a href="/blog/2013-05-10.html">Things we learned at the LUG meet</a><br><span class="date">(2013-05-10)</span></li>

<li><a href="/blog/2013-02-11.html">Git aux</a><br><span class="date">(2013-02-11)</span></li>

<li><a href="/blog/2012-08-30.html" class="selected">Lost at C</a><br><span class="date">(2012-08-30)</span></li>

<li><a href="/blog/2012-07-07.html">Ire</a><br><span class="date">(2012-07-07)</span></li>

<li><a href="/blog/2011-10-27.html">Break In!</a><br><span class="date">(2011-10-27)</span></li>

<li><a href="/blog/2011-10-22.html">xmodmap Hints and Tips</a><br><span class="date">(2011-10-22)</span></li>
</ul>
</nav>

        <main>
            <h1>Lost at C</h1>
<p>This week I've learned a few things (always the mark of a good week in
my book), the foremost of which is that I don’t know very much about
<a href="https://en.wikipedia.org/wiki/Programming_language">C</a>.</p>
<p>I expect this post will mostly result in comments such as "well, duh…"
and the like :)</p>
<h2>How I spent an afternoon chasing a star...</h2>
<p>After a fairly relaxing bank holiday weekend, I came back to work on
Tuesday to find myself in the position of needing a to write a library
for a client to plug into their software and to have it ready by Friday.</p>
<p>Though I’d written <a href="http://falsoyd.sourceforge.net/">some (very bad) C++</a> while at
<a href="http://www.uea.ac.uk/">uni</a>, I've fairly recently written a couple of
very small utilities in C (the library they use is written in C and I
fancied a challenge) and wanted to learn some more, so I chose C as the
language to write in.</p>
<p>This afternoon, with the library and a small demo application written, I
handed the code over to my colleague who’d promised to do all the
necessary wrapping up to take my developed-in-linux code and produce a
windows DLL from it. After a short while, he’d compiled the library and
the demo, BUT… the demo app crashed every time.</p>
<p>At first, it looked like I’d forgotten to free() some malloc()ed memory.
I had; but even after doing so, the code was still crashing in windows.
The search continued for quite some time until I eventually found what
was wrong.</p>
<p>There was an asterisk where there shouldn't have been, FFS!</p>
<p>It turns out that I’d carried some pre-conceptions with me from my
previous life as a Java developer and various other places. I’m so used
to pretty much every language passing things around by value when the
data is small (ints, chars, etc.) and by reference when it’s not
(objects, etc.). I was completely unprepared for the fact that C deals
<em>only</em> in values.</p>
<p>I’m not one of those who are scared of pointers, I’m quite comfortable
with pointer arithmetic, allocating and freeing memory and the like.
What I had was some code like this:</p>
<pre><code>typedef struct {
    int a;
    int b;
} AB;

void do_some_stuff(int *a, int *b, int num_records, AB **out) {
    int i;
    AB ab[num_records];

    for(i=0; i&lt;num_records; i++) {
        ab[i].a = a[i];
        ab[i].b = b[i];
    }

    *out = ab;
}

void get_stuff() {
    int a[2] = {1, 2};
    int b[2] = {3, 4};

    AB *ab;

    do_some_stuff(a, b, 2, &amp;ab);

    // Do some stuff with ab;
}
</code></pre>
<p>Although the real code actually did useful things :P</p>
<p>After handing the code over however, it transpired that MSVC doesn't
support all of C99 (why pick a standard and implement part of it?!)
specifically, variable-length arrays; so the <code>AB ab[num_records]</code> line
had to go.</p>
<p>Here’s where my preconception came in:</p>
<p>So that array declaration became
<code>AB *ab = malloc(sizeof(AB*) * num_records)</code> and a corresponding
<code>free(ab)</code> in <code>get_stuff()</code>.</p>
<p>Yep, nothing in C is a reference unless you really, really say it is.
Arrays of structs are just like arrays of any other type: a sequence of
those things laid end to end in memory. <code>sizeof(AB*)</code> needed to be
<code>sizeof(AB)</code> and that was it.</p>
<p><span id="The. Entire. Afternoon."></span><strong>The. Entire. Afternoon.</strong></p>
<p>Consider that my lesson learned.</p>
<p>Luckily, I seem to have ended up quite fond of C, pleasantly more aware
of how it works, and quite keen to write some more.</p>

            <footer>&copy; 2024, Steve Engledow</footer>
        </main>
    </body>
</html>
