<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="Stylesheet" type="text/css" href="../../style.css" />
        <title>2015-09-17</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    </head>
    <body>
        <header>
            <nav>
                <p>
                    <a href="../../index.html">Home</a>
                    <a href="../../projects.html">Projects</a>
                    <a href="../../diary/index.html">Blog</a>
                </p>
            </nav>
        </header>

        <main>
            
<p>
---
title: Twofer
tags: security linux
---
</p>

<p>
After toying with the idea for some time, I decided I'd try setting up [2FA](<a href="https://en.wikipedia.org/wiki/Two-factor_authentication)">https://en.wikipedia.org/wiki/Two-factor_authentication)</a> on my laptop. As usual, the [arch wiki](<a href="https://wiki.archlinux.org/)">https://wiki.archlinux.org/)</a> had a nicely written [article on setting up 2FA](<a href="https://wiki.archlinux.org/index.php/Google_Authenticator)">https://wiki.archlinux.org/index.php/Google_Authenticator)</a> with [the PAM module](<a href="https://github.com/google/google-authenticator/tree/master/libpam)">https://github.com/google/google-authenticator/tree/master/libpam)</a> for [Google Authenticator](<a href="https://github.com/google/google-authenticator).">https://github.com/google/google-authenticator).</a>
</p>

<p>
I followed the instructions for setting up 2FA for ssh and that worked seamlessly so I decided I'd then go the whole hog and enable the module in <code>/etc/pam.d/system-auth</code> which would mean I'd need it any time I had to login at all.
</p>

<p>
Adding the line:
</p>

<p>
```config 
auth  sufficient  pam_google_authenticator.so
```
</p>

<p>
had the expected effect that I could login with just the verification code but that seems to defeat the point a little so I bit my lip and changed <code>sufficient</code> to <code>required</code> which would mean I'd need my password and the code on login.
</p>

<p>
I switched to another [VT](<a href="https://en.wikipedia.org/wiki/Virtual_terminal)">https://en.wikipedia.org/wiki/Virtual_terminal)</a> and went for it. It worked!
</p>

<p>
So then I rebooted.
</p>

<p>
And I couldn't log in.
</p>

<p>
After a couple of minutes to download an ISO to boot from using another machine, putting it on a USB stick, booting from it, and editing my <code>system-auth</code> file, I realised why:
</p>

<p>
```config 
auth      required    pam_google_authenticator.so
auth      required    pam_unix.so     try_first_pass nullok
auth      required    pam_ecryptfs.so unwrap
```
</p>

<p>
My home partition is encrypted and so the Google authenticator module obviously couldn't load my secret file until I'd already logged in.
</p>

<p>
![D'oh](<a href="https://static.offend.me.uk/media/images/facepalm.jpg)">https://static.offend.me.uk/media/images/facepalm.jpg)</a>
</p>

<p>
I tried moving the <code>pam_google_authenticator.so</code> line to the bottom of the <code>auth</code> group but that didn't work either.
</p>

<p>
## How could this possibly go wrong...
</p>

<p>
So, the solution I came up with was to put the 2fa module into the session group. My understanding is that this will mean PAM will ask me to supply a verification code once per session which is fine by me; I don't want to have to put a code in every time I <code>sudo</code> anyway.
</p>

<p>
My question is, will my minor abuse of PAM bite me in the arse at any point? It seems to do what I expected, even if I log in through GDM.
</p>

<p>
Here's my current <code>system-auth</code> file:
</p>

<p>
```config 
#%PAM-1.0
</p>

<p>
auth      required  pam_unix.so     try_first_pass nullok
auth      required  pam_ecryptfs.so unwrap
auth      optional  pam_permit.so
auth      required  pam_env.so
</p>

<p>
account   required  pam_unix.so
account   optional  pam_permit.so
account   required  pam_time.so
</p>

<p>
password  optional  pam_ecryptfs.so
password  required  pam_unix.so     try_first_pass nullok sha512 shadow
password  optional  pam_permit.so
</p>

<p>
session   required  pam_limits.so
session   required  pam_unix.so
session   optional  pam_ecryptfs.so unwrap
session   optional  pam_permit.so
session   required  pam_google_authenticator.so
```
</p>

        </main>

        <footer>
            <p>
            All content Â© 2011-2024 Steve Engledow.
            <br />
            All views expressed here are mine and don't reflect those of Amazon.
            <br />
            The <a href="https://github.com/stilvoid/stilvoid.github.io">contents of this web site</a> are available under the terms of the <a href="https://github.com/stilvoid/stilvoid.github.io/blob/master/LICENSE">MIT licence</a>.
            </p>
        </footer>
    </body>
</html>
